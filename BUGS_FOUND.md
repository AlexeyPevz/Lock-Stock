# üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å–∏—Å—Ç–µ–º —Å–µ—Å—Å–∏–π**
**–§–∞–π–ª—ã:** `src/handlers/commands.ts`, `src/handlers/admin.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–µ —Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–µ—Å—Å–∏–π:
- Grammy `ctx.session` - –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
- Map `sessions` - –¥–ª—è –∏–≥—Ä–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

**–†–∏—Å–∫:** –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∫–∏ –∏ –∏–≥—Ä—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –ê–¥–º–∏–Ω —Ä–µ–∂–∏–º—ã –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ù—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É –Ω–∞ Grammy sessions
// –ò–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ —Å–∏—Å—Ç–µ–º—ã
```

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π**
**–§–∞–π–ª:** `src/index.ts:124`

**–ü—Ä–æ–±–ª–µ–º–∞:** `const sessions = new Map<number, Session>();` - —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏

**–†–∏—Å–∫:** –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—Å–µ –∏–≥—Ä—ã –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –ë–î –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Grammy persistent sessions

## üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 3. **–ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
**–§–∞–π–ª:** `src/stats/collector.ts`

**–ü—Ä–æ–±–ª–µ–º—ã:**
```typescript
verificationSuccessRate: '0%', // TODO: Implement
skipUsage: 0, // TODO: Implement
timerUsage: {}, // TODO: Implement
revenueToday: 0, // TODO: Implement
errorRate: '0%', // TODO: Implement
avgResponseTime: 0, // TODO: Implement
```

**–†–∏—Å–∫:** –ù–µ–ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ

### 4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Ç–∏–ø–æ–≤**
**–ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤**

**–ü—Ä–æ–±–ª–µ–º—ã:**
- 72+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `any`
- –ü–æ—Ç–µ—Ä—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ runtime –æ—à–∏–±–∫–∏

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏ –¥–ª—è API**
**–§–∞–π–ª:** `src/generation/sgr-generator.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ OpenRouter –Ω–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff

**–†–∏—Å–∫:** –ë—ã—Å—Ç—Ä–æ–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö

## üü¢ –ú–∏–Ω–æ—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 6. **Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è**
**–ü—Ä–∏–º–µ—Ä—ã:**
- –ú–∞–∫—Å–∏–º—É–º 1000 –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –¢–∞–π–º–∞—É—Ç—ã –±–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –†–∞–∑–º–µ—Ä—ã –±–∞—Ç—á–µ–π

### 7. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
**–ü—Ä–æ–±–ª–µ–º—ã:**
- Callback data –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–æ–π –¥–ª–∏–Ω—ã
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ—Ç rate limiting

### 8. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏**
**–§–∞–π–ª:** `src/generation/sgr-generator.ts:33`

**–ü—Ä–æ–±–ª–µ–º–∞:** `stats` –º–∞—Å—Å–∏–≤ —Ä–∞—Å—Ç–µ—Ç –¥–æ 1000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–æ –æ—á–∏—â–∞–µ—Ç—Å—è —Ä–µ–∑–∫–æ

### 9. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è "typing"**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –¥–æ–ª–≥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

### 10. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –ø—Ä–∏–¥–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

## üõ†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–µ—Å—Å–∏–π**
   ```typescript
   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Grammy sessions —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
   bot.use(session({
     storage: new FileAdapter({ dirName: 'sessions' }),
     // –∏–ª–∏
     // storage: new MongoDBAdapter({ ... })
   }));
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π**
   ```typescript
   // –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
   await saveSessionToDB(chatId, session);
   ```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–≤–∞–∂–Ω–æ):
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É**
4. **–ó–∞–º–µ–Ω–∏—Ç—å `any` –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã**
5. **–î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff**

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
6. **–í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥**
7. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
8. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –ø–∞–º—è—Ç—å—é**
9. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ü–∏—é "typing"**
10. **–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–π**

## üìã –ß–µ–∫-–ª–∏—Å—Ç –±—ã—Å—Ç—Ä—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å –≤ .env
SESSION_TTL=86400  # 24 —á–∞—Å–∞
MAX_CALLBACK_LENGTH=64
RATE_LIMIT_MESSAGES=30
RATE_LIMIT_WINDOW=60

# 2. –î–æ–±–∞–≤–∏—Ç—å –≤ package.json
"@grammyjs/storage-file": "^2.4.0"  # –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö —Å–µ—Å—Å–∏–π

# 3. –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–µ—Å—Å–∏–π
mkdir -p data/sessions

# 4. –î–æ–±–∞–≤–∏—Ç—å –≤ .gitignore
data/sessions/
```

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã Telegram API**
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è: 4096 —Å–∏–º–≤–æ–ª–æ–≤
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä callback_data: 64 –±–∞–π—Ç–∞
   - Rate limits: 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ Node.js**
   - better-sqlite3 –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ü—Ä–∏ 1000+ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Map —Å–µ—Å—Å–∏–π –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º

## üéØ –ò—Ç–æ–≥

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤:** 2 (–∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å–µ—Å—Å–∏–π, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
**–°—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 3 (–Ω–µ–ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, any —Ç–∏–ø—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry)
**–ú–∏–Ω–æ—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:** 5

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è: –¥–≤–µ —Å–∏—Å—Ç–µ–º—ã —Å–µ—Å—Å–∏–π –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π. –≠—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.